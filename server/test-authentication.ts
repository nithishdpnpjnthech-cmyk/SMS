/**
 * COMPREHENSIVE AUTHENTICATION TESTING SCRIPT
 * 
 * This script tests all aspects of the student authentication system:
 * 1. Database migration
 * 2. Admin creates student with proper password
 * 3. Student login with correct password
 * 4. Student login with wrong password (should fail)
 * 5. Inactive student login (should fail)
 * 6. Rate limiting
 * 7. Account locking
 * 8. Security features
 */\n\nimport { storage } from './storage';\nimport { runMigration } from './migrate-student-auth';\nimport {\n  generateDefaultPassword,\n  hashPassword,\n  verifyPassword,\n  createStudentWithAuth,\n  authenticateStudent,\n  checkRateLimit,\n  sanitizeForLog\n} from './student-auth-fix';\nimport { randomUUID } from 'crypto';\n\ninterface TestResult {\n  name: string;\n  passed: boolean;\n  message: string;\n  duration: number;\n}\n\nclass AuthenticationTester {\n  private results: TestResult[] = [];\n  private testStudentId: string | null = null;\n  private testBranchId: string | null = null;\n  private testBatchId: string | null = null;\n  private testProgramId: string | null = null;\n\n  async runTest(name: string, testFn: () => Promise<void>): Promise<void> {\n    const startTime = Date.now();\n    try {\n      await testFn();\n      const duration = Date.now() - startTime;\n      this.results.push({ name, passed: true, message: 'PASSED', duration });\n      console.log(`‚úÖ ${name} - PASSED (${duration}ms)`);\n    } catch (error: any) {\n      const duration = Date.now() - startTime;\n      this.results.push({ name, passed: false, message: error.message, duration });\n      console.log(`‚ùå ${name} - FAILED: ${error.message} (${duration}ms)`);\n    }\n  }\n\n  async setupTestData(): Promise<void> {\n    console.log('üîß Setting up test data...');\n    \n    // Create test branch\n    this.testBranchId = randomUUID();\n    await storage.query(`\n      INSERT INTO branches (id, name, address, phone, created_at)\n      VALUES (?, 'Test Branch', 'Test Address', '1234567890', NOW())\n    `, [this.testBranchId]);\n    \n    // Create test program\n    this.testProgramId = randomUUID();\n    await storage.query(`\n      CREATE TABLE IF NOT EXISTS programs (\n        id VARCHAR(36) PRIMARY KEY,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        description TEXT,\n        is_active BOOLEAN DEFAULT true,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    \n    await storage.query(`\n      INSERT INTO programs (id, name, description, is_active)\n      VALUES (?, 'Test Program', 'Test Program Description', true)\n    `, [this.testProgramId]);\n    \n    // Create test batch\n    this.testBatchId = randomUUID();\n    await storage.query(`\n      CREATE TABLE IF NOT EXISTS batches (\n        id VARCHAR(36) PRIMARY KEY,\n        name VARCHAR(255) NOT NULL UNIQUE,\n        is_active BOOLEAN DEFAULT true,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    \n    await storage.query(`\n      INSERT INTO batches (id, name, is_active)\n      VALUES (?, 'Test Batch 2025-A', true)\n    `, [this.testBatchId]);\n    \n    console.log('‚úÖ Test data setup completed');\n  }\n\n  async cleanupTestData(): Promise<void> {\n    console.log('üßπ Cleaning up test data...');\n    \n    if (this.testStudentId) {\n      await storage.query('DELETE FROM student_programs WHERE student_id = ?', [this.testStudentId]);\n      await storage.query('DELETE FROM students WHERE id = ?', [this.testStudentId]);\n    }\n    \n    if (this.testBranchId) {\n      await storage.query('DELETE FROM branches WHERE id = ?', [this.testBranchId]);\n    }\n    \n    if (this.testProgramId) {\n      await storage.query('DELETE FROM programs WHERE id = ?', [this.testProgramId]);\n    }\n    \n    if (this.testBatchId) {\n      await storage.query('DELETE FROM batches WHERE id = ?', [this.testBatchId]);\n    }\n    \n    console.log('‚úÖ Test data cleanup completed');\n  }\n\n  async runAllTests(): Promise<void> {\n    console.log('üöÄ Starting Comprehensive Authentication Tests...');\n    console.log('=' .repeat(60));\n    \n    try {\n      await this.setupTestData();\n      \n      // Test 1: Database Migration\n      await this.runTest('Database Migration', async () => {\n        await runMigration();\n      });\n      \n      // Test 2: Password Generation\n      await this.runTest('Password Generation', async () => {\n        const password1 = generateDefaultPassword('Ramesh Kumar');\n        if (password1 !== 'rames') {\n          throw new Error(`Expected 'rames', got '${password1}'`);\n        }\n        \n        const password2 = generateDefaultPassword('John Doe');\n        if (password2 !== 'johnd') {\n          throw new Error(`Expected 'johnd', got '${password2}'`);\n        }\n        \n        const password3 = generateDefaultPassword('A');\n        if (password3 !== 'a') {\n          throw new Error(`Expected 'a', got '${password3}'`);\n        }\n      });\n      \n      // Test 3: Password Hashing\n      await this.runTest('Password Hashing', async () => {\n        const plainPassword = 'rames';\n        const hashedPassword = await hashPassword(plainPassword);\n        \n        if (!hashedPassword || hashedPassword.length < 50) {\n          throw new Error('Password hash is too short or empty');\n        }\n        \n        const isValid = await verifyPassword(plainPassword, hashedPassword);\n        if (!isValid) {\n          throw new Error('Password verification failed');\n        }\n        \n        const isInvalid = await verifyPassword('wrongpassword', hashedPassword);\n        if (isInvalid) {\n          throw new Error('Wrong password should not verify');\n        }\n      });\n      \n      // Test 4: Admin Creates Student\n      await this.runTest('Admin Creates Student', async () => {\n        const studentData = {\n          name: 'Ramesh Kumar',\n          email: 'ramesh.test@example.com',\n          phone: '9876543210',\n          parentPhone: '9876543211',\n          address: 'Test Address',\n          branchId: this.testBranchId,\n          batchId: this.testBatchId,\n          programs: [this.testProgramId],\n          status: 'active'\n        };\n        \n        const student = await createStudentWithAuth(storage, studentData);\n        this.testStudentId = student.id;\n        \n        if (!student.id || !student.defaultPassword) {\n          throw new Error('Student creation failed - missing ID or password');\n        }\n        \n        if (student.defaultPassword !== 'rames') {\n          throw new Error(`Expected password 'rames', got '${student.defaultPassword}'`);\n        }\n        \n        // Verify student exists in database with password hash\n        const dbStudent = await storage.query(\n          'SELECT id, name, password_hash, role FROM students WHERE id = ?',\n          [student.id]\n        );\n        \n        if (!dbStudent.length || !dbStudent[0].password_hash) {\n          throw new Error('Student not found in database or missing password hash');\n        }\n        \n        if (dbStudent[0].role !== 'STUDENT') {\n          throw new Error(`Expected role 'STUDENT', got '${dbStudent[0].role}'`);\n        }\n      });\n      \n      // Test 5: Student Login Success\n      await this.runTest('Student Login Success', async () => {\n        if (!this.testStudentId) {\n          throw new Error('Test student not created');\n        }\n        \n        const result = await authenticateStudent(storage, this.testStudentId, 'rames');\n        \n        if (!result || result.name !== 'Ramesh Kumar') {\n          throw new Error('Authentication failed or wrong student data returned');\n        }\n        \n        if (result.role !== 'student') {\n          throw new Error(`Expected role 'student', got '${result.role}'`);\n        }\n      });\n      \n      // Test 6: Student Login with Email\n      await this.runTest('Student Login with Email', async () => {\n        const result = await authenticateStudent(storage, 'ramesh.test@example.com', 'rames');\n        \n        if (!result || result.name !== 'Ramesh Kumar') {\n          throw new Error('Email-based authentication failed');\n        }\n      });\n      \n      // Test 7: Student Login with Phone\n      await this.runTest('Student Login with Phone', async () => {\n        const result = await authenticateStudent(storage, '9876543210', 'rames');\n        \n        if (!result || result.name !== 'Ramesh Kumar') {\n          throw new Error('Phone-based authentication failed');\n        }\n      });\n      \n      // Test 8: Wrong Password Fails\n      await this.runTest('Wrong Password Fails', async () => {\n        try {\n          await authenticateStudent(storage, this.testStudentId!, 'wrongpassword');\n          throw new Error('Authentication should have failed with wrong password');\n        } catch (error: any) {\n          if (!error.message.includes('Invalid password')) {\n            throw new Error(`Expected 'Invalid password' error, got: ${error.message}`);\n          }\n        }\n      });\n      \n      // Test 9: Non-existent Student Fails\n      await this.runTest('Non-existent Student Fails', async () => {\n        try {\n          await authenticateStudent(storage, 'nonexistent@example.com', 'password');\n          throw new Error('Authentication should have failed for non-existent student');\n        } catch (error: any) {\n          if (!error.message.includes('Student not found')) {\n            throw new Error(`Expected 'Student not found' error, got: ${error.message}`);\n          }\n        }\n      });\n      \n      // Test 10: Inactive Student Fails\n      await this.runTest('Inactive Student Fails', async () => {\n        // Make student inactive\n        await storage.query(\n          'UPDATE students SET status = ? WHERE id = ?',\n          ['inactive', this.testStudentId]\n        );\n        \n        try {\n          await authenticateStudent(storage, this.testStudentId!, 'rames');\n          throw new Error('Authentication should have failed for inactive student');\n        } catch (error: any) {\n          if (!error.message.includes('Student not found')) {\n            throw new Error(`Expected 'Student not found' error, got: ${error.message}`);\n          }\n        }\n        \n        // Reactivate student for other tests\n        await storage.query(\n          'UPDATE students SET status = ? WHERE id = ?',\n          ['active', this.testStudentId]\n        );\n      });\n      \n      // Test 11: Rate Limiting\n      await this.runTest('Rate Limiting', async () => {\n        const testIdentifier = 'ratelimit@test.com';\n        \n        // First 10 attempts should pass\n        for (let i = 0; i < 10; i++) {\n          const allowed = checkRateLimit(testIdentifier);\n          if (!allowed) {\n            throw new Error(`Rate limit triggered too early at attempt ${i + 1}`);\n          }\n        }\n        \n        // 11th attempt should be blocked\n        const blocked = checkRateLimit(testIdentifier);\n        if (blocked) {\n          throw new Error('Rate limit should have blocked 11th attempt');\n        }\n      });\n      \n      // Test 12: Security Utilities\n      await this.runTest('Security Utilities', async () => {\n        const maliciousInput = 'test\\r\\nmalicious\\tcode';\n        const sanitized = sanitizeForLog(maliciousInput);\n        \n        if (sanitized.includes('\\r') || sanitized.includes('\\n') || sanitized.includes('\\t')) {\n          throw new Error('Log injection characters not properly sanitized');\n        }\n        \n        const longInput = 'a'.repeat(200);\n        const truncated = sanitizeForLog(longInput);\n        \n        if (truncated.length > 100) {\n          throw new Error('Long input not properly truncated');\n        }\n      });\n      \n      // Test 13: Account Locking (simulate multiple failed attempts)\n      await this.runTest('Account Locking', async () => {\n        // Reset login attempts\n        await storage.query(\n          'UPDATE students SET login_attempts = 0, locked_until = NULL WHERE id = ?',\n          [this.testStudentId]\n        );\n        \n        // Make 4 failed attempts (should not lock yet)\n        for (let i = 0; i < 4; i++) {\n          try {\n            await authenticateStudent(storage, this.testStudentId!, 'wrongpassword');\n          } catch (error) {\n            // Expected to fail\n          }\n        }\n        \n        // 5th failed attempt should lock the account\n        try {\n          await authenticateStudent(storage, this.testStudentId!, 'wrongpassword');\n        } catch (error) {\n          // Expected to fail\n        }\n        \n        // Now even correct password should fail due to lock\n        try {\n          await authenticateStudent(storage, this.testStudentId!, 'rames');\n          throw new Error('Authentication should have failed due to account lock');\n        } catch (error: any) {\n          if (!error.message.includes('locked')) {\n            throw new Error(`Expected 'locked' error, got: ${error.message}`);\n          }\n        }\n        \n        // Reset for cleanup\n        await storage.query(\n          'UPDATE students SET login_attempts = 0, locked_until = NULL WHERE id = ?',\n          [this.testStudentId]\n        );\n      });\n      \n    } finally {\n      await this.cleanupTestData();\n    }\n    \n    this.printResults();\n  }\n\n  printResults(): void {\n    console.log('\\n' + '=' .repeat(60));\n    console.log('üìä TEST RESULTS SUMMARY');\n    console.log('=' .repeat(60));\n    \n    const passed = this.results.filter(r => r.passed).length;\n    const failed = this.results.filter(r => r.passed === false).length;\n    const totalTime = this.results.reduce((sum, r) => sum + r.duration, 0);\n    \n    console.log(`Total Tests: ${this.results.length}`);\n    console.log(`Passed: ${passed} ‚úÖ`);\n    console.log(`Failed: ${failed} ‚ùå`);\n    console.log(`Total Time: ${totalTime}ms`);\n    console.log(`Success Rate: ${Math.round((passed / this.results.length) * 100)}%`);\n    \n    if (failed > 0) {\n      console.log('\\n‚ùå FAILED TESTS:');\n      this.results\n        .filter(r => !r.passed)\n        .forEach(r => {\n          console.log(`   ${r.name}: ${r.message}`);\n        });\n    }\n    \n    if (passed === this.results.length) {\n      console.log('\\nüéâ ALL TESTS PASSED! Student authentication system is working correctly.');\n      console.log('\\n‚úÖ VERIFICATION COMPLETE:');\n      console.log('   ‚Ä¢ Admin can create students with secure passwords');\n      console.log('   ‚Ä¢ Students can login with first 5 letters of their name');\n      console.log('   ‚Ä¢ Passwords are securely hashed with bcrypt');\n      console.log('   ‚Ä¢ Wrong passwords are rejected');\n      console.log('   ‚Ä¢ Inactive students cannot login');\n      console.log('   ‚Ä¢ Rate limiting prevents brute force attacks');\n      console.log('   ‚Ä¢ Account locking protects against repeated failures');\n      console.log('   ‚Ä¢ Security utilities prevent log injection');\n    } else {\n      console.log('\\n‚ö†Ô∏è  SOME TESTS FAILED - Please review and fix issues before production use.');\n    }\n  }\n}\n\n// Run tests if this file is executed directly\nif (import.meta.url === `file://${process.argv[1]}`) {\n  const tester = new AuthenticationTester();\n  tester.runAllTests()\n    .then(() => {\n      console.log('\\nTesting completed');\n      process.exit(0);\n    })\n    .catch((error) => {\n      console.error('\\nTesting failed:', error);\n      process.exit(1);\n    });\n}\n\nexport { AuthenticationTester };